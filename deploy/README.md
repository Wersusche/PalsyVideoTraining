# Deployment automation

Этот каталог содержит автоматизацию Ansible для развёртывания backend-приложения на удалённый сервер (временно используя аутентификацию по логину и паролю).

## Требования

- Ansible 2.13+
- Локально установленный `rsync` (используется модулем `synchronize` для загрузки исходников)
- Доступ по SSH к серверу `45.67.230.58`

## Настройка доступа

1. Скопируйте `inventory.ini` в отдельный файл или отредактируйте существующий, указав реальный логин/пароль. Для безопасности рекомендуется хранить пароль в Ansible Vault, но на начальном этапе допустимо оставить его в открытом виде.
2. При необходимости скорректируйте переменные в `group_vars/prod.yml` (порт сервиса, путь БД и т. д.).

## Файлы

- `ansible.cfg` — настройки Ansible (отключён `host_key_checking` и переопределён вывод).
- `inventory.ini` — пример подключения к `45.67.230.58` по логину/паролю.
- `group_vars/prod.yml` — значения переменных, применяемых к группе `prod`.
- `playbooks/deploy_backend.yml` — основной плейбук развёртывания backend'а.
- `templates/backend.env.j2` — шаблон `.env` с URL базы данных.
- `templates/palsy-backend.service.j2` — шаблон systemd-сервиса для uvicorn.

## Запуск деплоя

```bash
cd deploy
ansible-playbook playbooks/deploy_backend.yml
```

Плейбук выполняет следующие шаги:

1. Устанавливает системные зависимости (Python 3, pip, build-essential, Node.js {{ nodejs_major_version }}, Nginx для проксирования).
2. Создаёт системного пользователя `palsy` и директории приложения в `/opt/palsy-backend`.
3. Копирует исходники backend'а и устанавливает зависимости в виртуальное окружение.
4. Копирует исходники frontend'а, выполняет `npm ci && npm run build` и выкладывает содержимое `dist/` в `{{ frontend_root }}`.
5. Применяет миграции Alembic.
6. Создаёт `.env` с учётом значений из `group_vars`.
7. Разворачивает и запускает systemd-сервис `palsy-backend.service`.
8. Настраивает Nginx в качестве обратного прокси (порт 80 → uvicorn) и раздачи статических файлов.

После успешного выполнения API будет доступен по адресу `http://45.67.230.58/` (конфиг Nginx перенаправляет на uvicorn, работающий на порту 8000).

## Переменные окружения

- `pvt_database_url` — строка подключения к PostgreSQL; значение попадает в `.env` как `PVT_DATABASE_URL`.
- `palsy_domain` — (опционально) доменное имя для блока server_name в Nginx. По умолчанию используется IP.
- `uvicorn_port` — внутренний порт uvicorn (по умолчанию 8000).
- `nodejs_major_version` — основная версия Node.js для установки из репозитория NodeSource (по умолчанию 20.x).

При смене структуры проекта или добавлении фронтенда расширьте плейбук дополнительными задачами.
